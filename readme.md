# Используемые пины
## SPI пины
* SPI_CS (chip select): GPIO8 - PA11 // опускать и поднимать надо вручную во время чтения с малинки
* SPI_MISO (master input slave output): GPIO9 - PA12 // нужно активировать в терминале RPi командой **raspi-gpio set 9 a0**
* SPI_SCLK (clock): GPIO11 - PA14 // нужно активировать в терминале малинки командой **raspi-gpio set 11 a0**
## Пины взаимодействия малинки с микроконтроллером
* GO_pin: GPIO17 - PC31 // для RPi - вывод, для Atmel - ввод
* is_sampled_pin: GPIO27 - PC30 // для RPi - ввод, для Atmel - вывод
* ch_select_pin: GPIO22 - PC29 // для RPi - вывод, для Atmel - ввод
* is_written_pin: GPIO23 - PC28 // для RPi - ввод, для Atmel - вывод
## Каналы АЦП контроллера
* channel_0: PA20 - AO правого микрофона
* channel_1: PA19 - AO левого микрофона

# Логика взаимодействия

При работе микроконтроллер (Atmel) переключается между тремя режимами работы в соответствии с командами от малинки (RPi). В каждом состоянии горит соответствующий светодиод.

1. ### Состояние "READY" (синий светодиод слева)

В этом состоянии контроллер находится всегда, когда на GO_pin подан логический ноль. АЦП считывает сигнал с ползунка и устанавливает уровень триггера. Как только на GO_pin подана единица, микроконтроллер переводится в состояние "SAMPLING".

2. ### Состояние "SAMPLING" (желтый светодиод посередине)

Контроллер с помощью АЦП считывает сигнал с двух микрофонов (одновременно) с частотой 500 кГц и записывает данные в заготовленный двумерный массив размером 5000 (5000 измерений для каждого канала). При этом массив заполняется не полностью, а лишь на первые 500 ячеек, после чего начинает заполняться сначала, стирая предыдущие данные. После каждого измерения напряжение на channel_0 сравнивается с уровнем триггера, заданным в состоянии "READY", и если уровень channel_0 окажется выше, то массив дописывается до конца (не останавливаясь на 500). Таким образом, нужные измерения начинаются только после возбуждения звуковой волны в трубе.

После того как массив полностью заполнен, Atmel подает напряжение на is_sampled_pin и переходит в режим "WRITING".

3. ### Состояние "WRITING" (зеленый светодиод справа)

Сначала контроллер читает уровень с ch_select_pin и настраивается на передачу по SPI данных считанных с канала с номером, равным уровню на ch_select_pin. При этом на is_written_pin выставлен 0. Как только все данные будут переданы малинке, is_written_pin выставится в 1.

Затем Atmel снова будет считывать уровень ch_select_pin и как только он изменится, на is_written_pin выставится 0 и предыдущий алгоритм повторится.

В состояние "READY" Atmel вернется только когда считает с GO_pin логический ноль! 